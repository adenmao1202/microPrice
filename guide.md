# 微觀市場結構分析指南
*基於有限狀態馬可夫鏈的微觀價格模型*

## 目錄
1. [概述](#概述)
2. [理論基礎](#理論基礎)
3. [資料準備](#資料準備)
4. [模型估計](#模型估計)
5. [結果解讀](#結果解讀)
6. [實務應用](#實務應用)
7. [跨交易所套利策略](#跨交易所套利策略)

---

## 概述

這份指南將教你如何使用**有限狀態馬可夫鏈**來分析股票或加密貨幣的微觀市場結構，識別不同資產的交易特徵，並制定相應的交易策略。

### 核心概念
- **微觀價格** vs **中間價**：真實交易價格 vs 簡單的(買價+賣價)/2
- **訂單流不平衡**：買賣掛單量的相對強弱
- **價格發現機制**：市場如何從不平衡狀態調整到新的均衡價格

---

## 理論基礎

### 馬可夫鏈狀態定義
- **狀態空間**：$(I_t, S_t)$
  - $I_t$：不平衡指標 (離散化為 n 個等級)
  - $S_t$：價差指標 (離散化為 m 個等級)
  - 總共 $n \times m$ 個狀態

### 三個關鍵矩陣
1. **Q矩陣**：價格不動時的狀態轉移機率
2. **R1矩陣**：價格變動幅度的機率分佈
3. **R2矩陣**：價格變動後新狀態的機率分佈

### 微觀價格調整公式
```
第一階調整: g¹ = (I - Q)⁻¹ × R1 × K
遞迴調整: g^(n+1) = B × g^n，其中 B = (I - Q)⁻¹ × R2
累積調整: p⁶ - M = g¹ + g² + ... + g⁶
```

---

## 資料準備

### 必要資料欄位
| 欄位名稱 | 說明 | 範例 |
|---------|------|------|
| `time` | 時間戳記 | 2024-01-01 09:30:00 |
| `bid` | 最佳買價 | 100.25 |
| `ask` | 最佳賣價 | 100.27 |
| `bs` | 買方掛單量 | 1000 |
| `as` | 賣方掛單量 | 800 |

### 資料清理步驟

#### 1. 計算基本指標
```
tick_size = 價差的最小正值
spread = (ask - bid) / tick_size (四捨五入到整數)
mid_price = (bid + ask) / 2
imbalance = bs / (bs + as)
```

#### 2. 資料過濾
- 移除 `spread <= 0` 的異常資料
- 移除 `spread > n_spread_max` 的極端資料
- 移除價格變動超過合理範圍的資料

#### 3. 離散化處理
- **不平衡度**：使用分位數分割成 n_imb 個桶 (建議 n_imb = 10)
- **價差**：按 tick 數量分割成 n_spread 個等級 (建議 n_spread = 2-4)

#### 4. 建立時滯變數
```
next_mid = mid_price.shift(-dt)
next_spread = spread.shift(-dt)  
next_imb_bucket = imb_bucket.shift(-dt)
dM = (next_mid - mid_price) / tick_size (四捨五入到 0.5 tick)
```

#### 5. 資料對稱化
為增加樣本數量，建立對稱副本：
- 將買盤優勢轉換為賣盤優勢
- 價格變動方向取反
- 合併原始資料和對稱資料

---

## 模型估計

### 步驟一：構建轉移計數矩陣

#### Q矩陣 (價格不動)
- 篩選條件：`dM == 0`
- 計算：當前狀態 → 下期狀態的轉移次數
- 組織：使用 block diagonal 結構處理不同價差等級

#### R1矩陣 (價格變動幅度)
- 篩選條件：`dM != 0`
- 目標變數：價格變動幅度 (通常為 [-0.01, -0.005, 0.005, 0.01])
- 計算：每個狀態到各變動幅度的轉移次數

#### R2矩陣 (變動後新狀態)
- 篩選條件：`dM != 0`
- 目標變數：變動後的新狀態 (spread, imb_bucket)
- 計算：當前狀態到新狀態的轉移次數

### 步驟二：標準化為機率矩陣
將計數矩陣的每一行標準化，使行和等於1：
```
對每個狀態 i：
    P[i, :] = counts[i, :] / sum(counts[i, :])
```

### 步驟三：計算微觀價格調整
1. 計算基本矩陣：`(I - Q)⁻¹`
2. 計算一階調整：`g1 = (I - Q)⁻¹ × R1 × K`
3. 計算遞迴矩陣：`B = (I - Q)⁻¹ × R2`
4. 計算高階調整：`g2, g3, ..., g6`

---

## 結果解讀

### 微觀價格調整圖

#### 關鍵觀察指標

**1. 斜率陡峭程度**
- **陡峭**：市場對不平衡高度敏感 (如 BAC)
- **平緩**：市場對不平衡反應溫和 (如 CVX)

**2. 不同價差線條的分離度**
- **分離明顯**：價差對價格發現影響大
- **幾乎重疊**：價差影響較小

**3. 中間價 vs 其他調整**
- **中間價調整為0**：驗證模型正確性
- **加權中間價**：已部分反映掛單量信息
- **spread調整**：完整的微觀價格調整

### 穩定分佈圖

#### 分佈形狀解讀

**U型分佈**：
- 極端不平衡狀態更穩定
- 市場容易極化
- 常見於高頻交易主導的市場

**鐘型分佈**：
- 中等不平衡狀態更常見
- 市場相對平衡
- 常見於機構投資者主導的市場

**平坦分佈**：
- 各種不平衡狀態機率相近
- 市場狀態變化溫和
- 常見於成熟穩定的市場

### 市場類型識別

#### 高頻交易主導市場
- 微觀調整斜率陡峭
- 價差敏感度高
- 1 tick價差呈現U型分佈
- 代表：科技股、熱門加密貨幣

#### 機構投資主導市場  
- 微觀調整相對平緩
- 價差敏感度低
- 分佈相對平坦
- 代表：能源股、公用事業股

---

## 實務應用

### 交易執行優化

#### 對於高敏感市場 (如BAC類型)
- **執行時機**：避開極端不平衡狀態
- **訂單大小**：極小，避免市場衝擊
- **執行策略**：高頻分批執行
- **風險控制**：嚴格止損，快進快出

#### 對於低敏感市場 (如CVX類型)
- **執行時機**：可以在不平衡狀態執行
- **訂單大小**：適中，市場容忍度高
- **執行策略**：穩健執行，無需過度分批
- **風險控制**：趨勢跟隨，較寬止損

### 風險管理

#### 動態頭寸調整
```
根據當前不平衡度和歷史調整幅度：
理論調整 = g1[current_state] + g2[current_state] + ...
實際頭寸價值 = 名義價值 + 理論調整 × 持倉量
```

#### 執行成本估算
```
預期滑價 = 微觀價格調整 × 市場衝擊係數
總執行成本 = 手續費 + 預期滑價 + 機會成本
```

---

## 跨交易所套利策略

### 策略原理
利用大交易所的不平衡資訊，在小交易所執行套利交易：
- **大交易所**：快速價格發現，提供訊號
- **小交易所**：價格發現滯後，提供套利機會

